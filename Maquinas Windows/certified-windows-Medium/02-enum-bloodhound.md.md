![](<attachments/creado-archivos-json-bloddhound.png>)

```bash
bloodhound-python -c All -u 'judith.mader' -p 'judith09' -ns 10.129.25.158 -d certified.htb
````

Using the credentials provided by the machine at the beginning, we run `bloodhound-python` to identify the best attack path.

![](<attachments/Pasted image 20260104212016.png>)

We upload the files generated by `bloodhound-python`.

![](<attachments/Shorted-paths-to-Domain-Admins.png>)

This is important because if BloodHound‚Äôs data isn‚Äôt updated, the next image won‚Äôt appear.

![](<attachments/add-owned-judith-mader.png>)  
![](<attachments/Outbound-object-control.png>)

Outbound-object-control

![](<attachments/write-owner-judith-to-management.png>)

- **Source:** `JUDITH.MADER@CERTIFIED.HTB`
    
- **Target:** `MANAGEMENT@CERTIFIED.HTB` (Group)
    
- **Edge:** `WriteOwner`
    
- ### üß† Exploitation Theory (CPTS)
    

The `WriteOwner` permission allows an attacker to take ownership of the target object.

1. **Ownership Takeover:** Change the owner of the `MANAGEMENT` group to `judith.mader`.
    
2. **DACL Modification:** As the owner, we can write to the DACL to grant ourselves privileges like `GenericAll` or `WriteMembers`.
    
3. **Group Enumeration:** Finally, we add ourselves to the group to inherit its permissions.
    

**Tools for exploitation:**

- `bloodyAD` (to change the owner).
    
- `dacledit.py` (to modify the DACL).
    
- `net rpc` (to add yourself to the group).
    

---

**Next Step:** Proceed to the ACL abuse phase in the note [[03-acl-abuse-writeowner]].

![](<attachments/Managment-to-Management_svc-path.png>)

- **Source:** `MANAGEMENT@CERTIFIED.HTB` (Controlled group)
    
- **Target:** `MANAGEMENT_SVC@CERTIFIED.HTB` (Target user)
    
- **Edge:** `GenericWrite`
    
- **Final Privilege:** `CanPSRemote` (WinRM access confirmed)
    
- ### üß† Exploitation Theory (CPTS)
    

As members of the `MANAGEMENT` group, we inherit the **GenericWrite** permission over the `management_svc` account.

**What does `GenericWrite` allow me to do?**  
This permission allows modifying non-protected attributes of the user object in AD. Although we could try attacks like _Targeted Kerberoasting_, the more modern and clean technique is **Shadow Credentials**:

1. **The Attack:** Abuse write access to modify the `msDS-KeyCredentialLink` attribute of `management_svc`.
    
2. **The Action:** Inject a public key (certificate) generated by us into that attribute.
    
3. **Authentication (PKINIT):** The Domain Controller trusts that key, allowing us to request a TGT (Ticket Granting Ticket) as if we were that user.
    
4. **Getting a Shell:**
    
    - Decrypt the TGT to obtain the user‚Äôs NTLM hash.
        
    - Since `management_svc` has **WinRM** permissions, we use that hash with `evil-winrm` to get an interactive shell.
        

**Tools for this phase:**

- `pywhisker` (to inject the shadow credential).
    
- `gettgtpkinit.py` (to request the ticket).
    
- `evil-winrm` (for final access).
    

---

**Next Step:** Execute the Shadow Credentials attack in the note  
5. [[04-shadow-creds-management.md]].

![](<attachments/Pasted image 20260105110659.png>)  
![](<attachments/Pasted image 20260105110727.png>)  
![](<attachments/Pasted image 20260105110840.png>)

As `management_svc`, we can reach `CA_OPERATOR`.

- With this data, we can use BloodHound PATHFINDING.  
    ![](<attachments/Pasted image 20260105111347.png>)
    

### Full Attack Chain Analysis (Master Plan)

**Objective:** Trace the path from initial access to control of the certificate infrastructure (ADCS).

JUDITH.MADER $\xrightarrow{\text{WriteOwner}}$ MANAGEMENT (Group) $\xrightarrow{\text{GenericWrite}}$ MANAGEMENT_SVC $\xrightarrow{\text{GenericAll}}$ CA_OPERATOR

#### üß© Hop Breakdown

**1. Group Takeover (Hop 1)**

- **Edge:** `WriteOwner` over the `MANAGEMENT` group.
    
- **Action:** `Judith` takes ownership of the group, modifies the DACL to give herself `FullControl`, and adds herself as a member.
    
- **Result:** We gain the privileges of the `MANAGEMENT` group.
    

**2. Lateral Movement (Hop 2)**

- **Edge:** `GenericWrite` over the `MANAGEMENT_SVC` user.
    
- **Technique:** **Shadow Credentials**. With write access, we inject a certificate into the `msDS-KeyCredentialLink` attribute of `management_svc`.
    
- **Result:** Interactive shell as `management_svc` (via WinRM).
    

**3. Prepare for PrivEsc (Hop 3)**

- **Edge:** `GenericAll` over the `CA_OPERATOR` user.
    
- **Meaning:** `GenericAll` is full control. We could change their password, but we‚Äôll use Shadow Credentials again for consistency and stealth (OPSEC).
    
- **Result:** Compromise of `ca_operator`.
    

#### üéØ Why is `CA_OPERATOR` critical?

The username itself is the key hint (CA = Certificate Authority).

BloodHound tells us how to reach it, but logic tells us why:

- This user likely has privileged permissions over the **Certificate Authority** or certificate templates.
    
- Controlling this user is the prerequisite to execute ADCS attacks (like ESC1, ESC6, or ESC9) and escalate to Domain Admin.
    

---

**Study note:** Notice how BloodHound basically ‚Äúhands us‚Äù the strategy. In the CPTS exam, take 5 minutes to search for long paths (`Pathfinding` -> `Shortest Path from Owned`) before you start throwing commands. It saves hours of blind testing.

---

## Advanced Attack Theory

### 1. DACL Modification (Abusing WriteOwner)

In this phase you move from `Judith` to the `Management` group.

- **Concept:** In Windows, the **Owner** of an object is basically ‚Äúgod‚Äù over that object. Even if the DACL explicitly says ‚ÄúJudith has NO access‚Äù, if Judith is the owner, the OS allows her to ignore that restriction and **rewrite the DACL**.
    
- **CPTS mindset:** Whenever you see `WriteOwner` in BloodHound, your brain should translate it as:  
    _"I can become owner ‚Üí I can give myself FullControl ‚Üí I can do whatever I want with this object"_.
    
- **Technique used:**
    
    1. **Takeover:** Use `bloodyAD` to claim ownership.
        
    2. **Grant Rights:** Use `dacledit.py` to write a new ACE granting `FullControl`.
        
    3. **Action:** Add yourself to the group using `net rpc`.
        

### 2. Shadow Credentials (Abusing GenericWrite/GenericAll)

This is the technique used twice: first to compromise `management_svc`, then `ca_operator`.

+1

- **Concept:** Traditionally, if you had write permissions (`GenericWrite` or `ForceChangePassword`) over a user, you would change their password. **Problem:** That‚Äôs noisy, breaks services, and alerts admins.
    
- **Evolution (Shadow Credentials):** Active Directory has an attribute called `msDS-KeyCredentialLink` used by Windows Hello for Business. This attribute allows associating a certificate (public key) to an account.
    
- **Why it matters in CPTS:** If you have `GenericWrite` or `GenericAll`, you can write to this attribute.
    
    1. Generate a key pair on Kali.
        
    2. Inject the public key into the victim user‚Äôs attribute (using `pywhisker`).
        
    3. Active Directory now ‚Äútrusts‚Äù your private key to authenticate as that user.
        
    4. **Result:** You get a TGT (Ticket Granting Ticket) without knowing or changing the user‚Äôs password. This is **stealthy and persistent**.
        

### 3. PKINIT & UnPAC the Hash (NTLM Extraction)

Once you have the certificate (via Shadow Credentials), how do you get a shell?

- **Concept:** Use Kerberos PKINIT (Public Key Cryptography for Initial Authentication). You authenticate with the certificate and the DC returns a TGT.
    
- **The trick (UnPAC the Hash):** When the DC issues a TGT, inside the ticket structure (specifically in the PAC ‚Äî Privilege Attribute Certificate), the DC includes the user‚Äôs NTLM hash for legacy compatibility.
    
- **CPTS application:**
    
    1. Use `gettgtpkinit.py` to exchange your certificate for a TGT.
        
    2. Use `getnthash.py` (or export the `KRB5CCNAME` variable) to read that TGT and extract the NTLM hash.
        
    3. With the NTLM hash, perform **Pass-the-Hash** with `evil-winrm` to get the shell.